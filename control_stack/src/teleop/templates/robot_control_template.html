<html>
  <script>
    kAKey = 65;
    kWKey = 87;
    kDKey = 68;
    kSKey = 83;
    kRobotName = "{{ robot_name }}";
    kForward = "forward";
    kBackward = "backward";
    kLeft = "left";
    kRight = "right";

    kCommandStatus = {};
    kCommandStatus[kForward] = false;
    kCommandStatus[kBackward] = false;
    kCommandStatus[kLeft] = false;
    kCommandStatus[kRight] = false;
    kCommandStatus.robot = kRobotName;

    kKeyCount = {};
    kKeyCount[kForward] = 0;
    kKeyCount[kBackward] = 0;
    kKeyCount[kLeft] = 0;
    kKeyCount[kRight] = 0;

    kKeyRepeatCount = 5;

    function status_update_callback(response_text) {
      // response = JSON.parse(response_text);
      document.getElementById("status").innerText = response_text;
    }

    function http_get_async(url, callback) {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.onreadystatechange = function() {
        if (xmlHttp.readyState === 4 && xmlHttp.status === 200)
          callback(xmlHttp.responseText);
      };
      xmlHttp.open("GET", url, true);
      xmlHttp.send(null);
    }

    function update_robot_status() {
      http_get_async("{{ status_update_path }}", status_update_callback);
      setTimeout(update_robot_status, 1000);
    }
    update_robot_status();

    function send_command() {
      var xhr = new XMLHttpRequest();
      xhr.open("POST", "{{ server_url }}", true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.send(JSON.stringify(kCommandStatus));
    }

    function start(direction) {
      kCommandStatus[direction] = true;
      send_command();
    }

    function stop(direction) {
      kCommandStatus[direction] = false;
      send_command();
    }

    function key_down(e) {
      switch (e.keyCode) {
        case kWKey: {
          ++kKeyCount[kForward];
          if (!e.repeat || (kKeyCount[kForward] % kKeyRepeatCount === 0)) {
            start(kForward);
          }
          break;
        }
        case kSKey: {
          ++kKeyCount[kBackward];
          if (!e.repeat || (kKeyCount[kBackward] % kKeyRepeatCount === 0)) {
            start(kBackward);
          }
          break;
        }
        case kAKey: {
          ++kKeyCount[kLeft];
          if (!e.repeat || (kKeyCount[kLeft] % kKeyRepeatCount === 0)) {
            start(kLeft);
          }
          break;
        }
        case kDKey: {
          ++kKeyCount[kRight];
          if (!e.repeat || (kKeyCount[kRight] % kKeyRepeatCount === 0)) {
            start(kRight);
          }
          break;
        }
      }
    }

    function key_up(e) {
      switch (e.keyCode) {
        case kWKey: {
          stop(kForward);
          kKeyCount[kForward] = 0;
          break;
        }
        case kSKey: {
          stop(kBackward);
          kKeyCount[kBackward] = 0;
          break;
        }
        case kAKey: {
          stop(kLeft);
          kKeyCount[kLeft] = 0;
          break;
        }
        case kDKey: {
          stop(kRight);
          kKeyCount[kRight] = 0;
          break;
        }
      }
    }

    document.onkeydown = key_down;
    document.onkeyup = key_up;

  </script>
  <body>
    <h1>{{ robot_name }} control page</h1>

    <p>Controls:</p>

    <p>WASD keys to move. W/D move forward and backwards; A/D rotate left and right.</p>

    <p>Robot status: <div id="status">Connecting...</div></p>

<!--    <table>-->
<!--      <tr>-->
<!--        <td></td>-->
<!--        <td><button onclick="clicked('forward')">Forward</button></td>-->
<!--        <td></td>-->
<!--      </tr>-->
<!--      <tr>-->
<!--        <td><button onclick="clicked('left')">Left</button></td>-->
<!--        <td></td>-->
<!--        <td><button onclick="clicked('right')">Right</button></td>-->
<!--      </tr>-->
<!--      <tr>-->
<!--        <td></td>-->
<!--        <td><button onclick="clicked('backward')">Backward</button></td>-->
<!--        <td></td>-->
<!--      </tr>-->
<!--    </table>-->
  </body>
</html>